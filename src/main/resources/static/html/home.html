<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <link type="text/css" rel="stylesheet" href="../layui/css/layui.css" />
        <style type="text/css">
            body {
                background-color: #D8E6E7;
            }
            .home-top {
                width: 100%;
                height: 65px;
                z-index: 999;
            }
            .top-content {
                background-color: #77AAAD;
                height: 65px;
                width: 1280px;
                margin: 0 auto;
            }
            .content-title {
                height: 65px;
            }
            .content-title-text {
                font-weight: bold;
                font-size: 16px;
                margin-top: 10px;
                margin-left: 50px;
                padding: 0;
            }
            .content-form {
                height: 65px;
            }
            .content-account {
                height: 65px;
            }
            .content-account-text div {
                display: inline-block;
                cursor: pointer;
                margin-left: 20px;
            }
            .content-account-text {
                text-align: right;
                font-size: 16px;
                margin-top: 20px;
                margin-right: 50px;
                padding: 0;
            }
            .content-account-text a:hover {
                color: #f1f1f1;
            }
            .content-account-text a:active {
                color: #5c5c5c;
            }
            .content-form-input .layui-input {
                width: 554px;
                height: 30px;
                margin-top: 16px;
                display: inline-block;
            }
            .content-form-input .layui-btn {
                height: 30px;
                line-height: 30px;
                padding: 0 12px;
            }
            .middle-content {
                background-color: #60a3bc;
                height: 155px;
                width: 1280px;
                margin: 5px auto 0;
            }
            .book-info {
                height: 155px;
                width: 880px !important;
                display: inline-block;
            }
            .other-info {
                height: 155px;
                width: 400px !important;
                background-color: #3c6382;
                color: #e9e9e9;
                text-align:justify;
                padding: 12px 20px 10px 10px;
            }
            .other-info-text {
                height: 92px;
            }
            .book-img {
                display: inline-block;
                width: 150px;
                height: 140px;
                overflow: hidden;
                justify-content: center;
            }
            .book-img img {
                max-width: 113px;
                max-height: 135px;
                vertical-align: middle;
                padding: 0px 0px;
                margin: 10px 0px 0px 15px;
            }
            .book-text {
                width: 680px;
                display: inline-block;
                vertical-align: top;
                padding-top: 10px;
                padding-bottom: 10px;
                font-size: 13px;
            }
            .book-text p {
                text-align:justify;
            }
            .other-info-more {
                text-align: right;
                margin-top: 24px;
            }
            .other-info-more a {
                cursor: pointer;
                color: #b8deff;
            }
            .other-info-more a:hover {
                color: #ffffff;
            }
            .other-info-more a:active {
                color: #b8deff;
            }
            .other-info-comment {
                color: #ffffff;
            }
            .home-middle {
                margin-top: 5px;
            }
            .management {
                margin-top: 5px;
                height: 40px !important;
            }
            .management .top-content{
                background-color: #009688;
                height: 40px;
                width: 1280px;
                margin: 0 auto;
            }
            .management-button {
                text-align: center;
                margin-top: 10px;
                font-size: 15px;
            }
            .management-button a {
                cursor: pointer;
            }
            .management-button a:hover {
                color: #FFFFFF;
            }
            .management-button a:active {
                color: #d6d6d6;
            }
            .home-bottom {
                height: 50px;
                text-align: center;
                font-size: 18px;
                line-height: 46px;
                color: #808080;
                cursor: pointer;
            }
            .home-bottom:hover {
                color: #464646;
            }
            .home-bottom:active {
                color: #808080;
            }
            .layui-fixbar .layui-fixbar-top {
                display: none;
                font-size: 40px;
            }
            .layui-fixbar li {
                width: 50px;
                height: 50px;
                line-height: 50px;
                margin-bottom: 1px;
                text-align: center;
                cursor: pointer;
                font-size: 30px;
                background-color: #00beac;
                color: #fff;
                border-radius: 5px;
                opacity: .95;
            }
        </style>
    </head>
    <body>
        <div class="home-top">
            <div class="layui-row top-content">
                <div class="layui-col-md3 content-title">
                    <div class="content-title-text">
                        <p>品论读书（ShareReading）</p>
                        <p>快乐来自分享</p>
                    </div>
                </div>
                <div class="layui-col-md7 content-form">
                    <div class="content-form-input">
                        <input autocomplete="off" id="keyword" placeholder="请输入ISBN/书名" class="layui-input" />
                        <button type="button" class="layui-btn" onclick="searchBookList();"><i class="layui-icon">&#xe615;</i>搜索</button>
                    </div>
                </div>
                <div class="layui-col-md2 content-account">
                    <div class="content-account-text">
                        <div><a onclick="openLogin();" id="loginName">登录</a></div>
                        <div><a onclick="openRegister();" id="register">注册</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="bookListMark"></div>
        <div class="layui-fixbar">
            <li class="layui-icon layui-fixbar-top" lay-type="top" style="display: list-item;" onclick="document.body.scrollTop = document.documentElement.scrollTop = 0;">&#xe604;</li>
        </div>
        <div class="home-bottom" onclick="getMoreBookList();">加载更多...</div>
    </body>
    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../layui/layui.js"></script>
    <script type="text/javascript">
        checkPermissions();
        var page = 1;
        var limit = 5;
        var layer;
        layui.use('layer', function(){
            layer = layui.layer;
            var params = {};
            params.id = window.localStorage.getItem("shareReading_user_id");
            params.session = window.localStorage.getItem("shareReading_user_session");
            // console.log(params)
            //检查登录信息是否存在
            var shareReading_user_session = window.localStorage.getItem("shareReading_user_session");
            if(shareReading_user_session != null && shareReading_user_session.length == 32) {
                var sessionTime = window.localStorage.getItem("shareReading_user_session_time");
                var date = new Date();
                if(((date.getTime() - parseInt(sessionTime))/1000.0/60) > 120) {
                    //本地信息过期，重新使用密钥登录
                    sessionLogin(params);
                } else {
                    //本地信息还有效，不操作，保持登录
                    login();
                }
            }
            getBookList(1);
        });
        //查看详情
        function getMoreInfo(bookId) {
            layer.open({
                type: 2,
                title: ['文本', 'background-color: #3c6382;color:#e9e9e9;'],
                shadeClose: true,
                shade: 0.8,
                area: ['1180px', '800px'],
                // offset: ['50%', '50%'],
                content: 'detail.html',//iframe的url
                move: false
            });
        }
        //打开登录页面
        function openLogin() {
            layer.open({
                type: 2,
                title: ['登录', 'background-color: #3c6382;color:#e9e9e9;'],
                shadeClose: false,
                shade: 0.8,
                area: ['500px', '430px'],
                // offset: ['50%', '50%'],
                content: 'login.html', //iframe的url
                move: false,
                end: function () {
                    if (window.localStorage.getItem("shareReading_user_session").length == 32) {
                        setTimeout(function () {
                            parent.location.reload();
                        }, 500);
                    } else {
                        return false;
                    }
                }
            });
        }
        //打开注册页面
        function openRegister() {
            layer.open({
                type: 2,
                title: ['注册', 'background-color: #3c6382;color:#e9e9e9;'],
                shadeClose: false,
                shade: 0.8,
                area: ['500px', '550px'],
                // offset: ['50%', '50%'],
                content: 'register.html', //iframe的url
                move: false
            });
        }
        //密钥登录
        function sessionLogin(params) {
            $.ajax({
                type : 'post',
                async : false,
                url : '/user/sessionLogin',
                contentType : 'application/json;charset=UTF-8',
                data : JSON.stringify(params),
                success : function(data) {
                    if(data.success){
                        // layer.msg(data.message, {shift: -1, time: 1000, icon: 1}, function(){
                        //
                        // });
                        // console.log(data);
                        window.localStorage.setItem("shareReading_user_email", data.user.user_email);
                        window.localStorage.setItem("shareReading_user_level", data.user.level);
                        window.localStorage.setItem("shareReading_user_name", data.user.user_name);
                        window.localStorage.setItem("shareReading_user_id", data.user.id);
                        window.localStorage.setItem("shareReading_user_session", data.user.session);
                        window.localStorage.setItem("shareReading_user_session_time", data.user.time);
                        login();
                    }else{
                        logout();
                    }
                }
            });
        }
        //登出数据处理
        function logout() {
            window.localStorage.setItem("shareReading_user_email", undefined);
            window.localStorage.setItem("shareReading_user_level", undefined);
            window.localStorage.setItem("shareReading_user_name", undefined);
            window.localStorage.setItem("shareReading_user_id", undefined);
            window.localStorage.setItem("shareReading_user_session", undefined);
            window.localStorage.setItem("shareReading_user_session_time", undefined);
            $("#loginName").html("登录");
            $("#loginName").attr("onclick", "openLogin();");
            $("#register").html("注册");
            $("#register").attr("onclick", "openRegister();");
            location.reload();
        }
        //登录数据处理
        function login() {
            var username = window.localStorage.getItem("shareReading_user_name");
            if(username != null && username != "") {
                if(username.length > 10) {
                    username = username.substr(0, 7) + "...";
                }
                $("#loginName").html(username);
                $("#loginName").attr("onclick", "return false;");
                $("#register").html("退出");
                $("#register").attr("onclick", "logout();");
            } else {
                return false;
            }
        }
        //检查页面权限
        function checkPermissions() {
            var shareReading_user_session = window.localStorage.getItem("shareReading_user_session");
            if(shareReading_user_session == null || shareReading_user_session.length != 32) {
                return false;
            }else if(window.localStorage.getItem("shareReading_user_level") == 1) {
                var addBookHtml = '<button type="button" class="layui-btn" id="addBook" onclick="openAddBook();"><i class="layui-icon">&#xe654;</i>添加书籍</button>';
                var managementHtml = '<div class="home-top management" id="management"><div class="layui-row top-content "><div class="layui-col-md2 management-button"><a>用户管理</a></div><div class="layui-col-md2 management-button"><a>权限管理</a></div><div class="layui-col-md2 management-button"><a>书籍管理</a></div><div class="layui-col-md2 management-button"></div><div class="layui-col-md2 management-button"></div><div class="layui-col-md2 management-button"></div></div></div>';
                $("#bookListMark").before(managementHtml);
                $(".content-form-input").append(addBookHtml);
            }
        }
        //打开书籍添加弹窗
        function openAddBook() {
            layer.open({
                type: 2,
                title: ['添加书籍', 'background-color: #3c6382;color:#e9e9e9;'],
                shadeClose: false,
                shade: 0.8,
                area: ['800px', '600px'],
                // offset: ['50%', '50%'],
                content: 'addBook.html', //iframe的url
                move: false
            });
        }
        function getBookList(type) {
            var keyword = $("#keyword").val();
            $.ajax({
                type : 'get',
                url : '/book/getBookList?page='+page+'&limit='+limit+'&keyword='+keyword,
                success : function(data) {
                    if(data.success){
                        console.log(data.bookList);
                        var bookList = data.bookList;
                        var html = '';
                        for (let i = 0; i < bookList.length; i++) {
                            //home-top
                            html += '<div class="home-middle"><div class="layui-row middle-content"><div class="layui-col-md8 book-info"><div class="book-img"><img src="' +
                                bookList[i].image + '" /></div><div class="book-text"><p>书名: 《' + bookList[i].name +
                                '》</p><p>作者: ' + bookList[i].author + '</p><p>出版社: ' + bookList[i].publisher + '</p><p>出版时间: ' + bookList[i].published + '<p>ISBN: ' + bookList[i].isbn +
                                '</p><p maxlength=148>书籍简介：' + (bookList[i].description.length > 148 ? (bookList[i].description.substr(0,148) + '...') : bookList[i].description) +
                                '</p></div></div><div class="layui-col-md4 other-info"><div class="other-info-text"><span class="other-info-comment">精选品论:</span><span maxlength=142>' +
                                '</span></div><div class="other-info-more"><a onclick="getMoreInfo(' + bookList[i].id + ');">查看更多<i class="layui-icon"></i></a></div></div></div></div>';
                        }
                        if(type = 1) {
                            $(".home-bottom").prop("onclick", "getMoreBookList();");
                            $("#bookListMark").append(html);
                        }
                        if(type = 2) {
                            $(".home-bottom").prop("onclick", "getMoreBookList();");
                            $("#bookListMark").append(html);
                        }
                        if(type = 3) {
                            $(".home-bottom").prop("onclick", "return false;");
                            $("#bookListMark").html("");
                            $("#bookListMark").append(html);
                        }
                    }else{
                        layer.msg(data.message, {shift: -1, time: 1000, icon: 1}, function(){

                        });
                    }
                }
            });
        }
        //获取更多书籍
        function getMoreBookList() {
            page+=1;
            getBookList(2);
        }
        //搜索书籍
        function searchBookList() {
            page=1;
            getBookList(3);
        }
    </script>
</html>